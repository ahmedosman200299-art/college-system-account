<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒÙ„ÙŠØ© Ø§Ù„Ù…ÙˆØ­Ø¯ 2026 | Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„</title>
    <style>
        :root { --dark: #0f172a; --gold: #d4af37; --bg: #f8fafc; --success: #10b981; --danger: #e11d48; --white: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: var(--bg); display: flex; min-height: 100vh; }
        
        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.9); display: none; justify-content: center; align-items: center; z-index: 30000; flex-direction: column; }
        
        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
        #receipt-print { display: none; }
        @media print {
            body * { visibility: hidden; }
            #receipt-print, #receipt-print * { visibility: visible; }
            #receipt-print { display: block; position: absolute; inset: 0; padding: 40px; background: white; border: 2px solid #000; }
        }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        .sidebar { width: 280px; background: var(--dark); color: white; height: 100vh; position: fixed; right: 0; display: flex; flex-direction: column; z-index: 1000; }
        .sidebar-header { padding: 30px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); color: var(--gold); font-size: 1.4rem; font-weight: bold; }
        .nav-item { padding: 18px 25px; cursor: pointer; transition: 0.3s; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .nav-item:hover { background: rgba(255,255,255,0.1); color: var(--gold); padding-right: 35px; }

        /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
        .main-content { margin-right: 280px; padding: 40px; width: calc(100% - 280px); }
        .section { background: var(--white); border-radius: 15px; padding: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 30px; border: 1px solid #e2e8f0; }
        
        /* Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ù„Ù…Ø¯Ø®Ù„Ø§Øª */
        input, select { padding: 12px; margin: 10px 0; border: 1px solid #cbd5e1; border-radius: 8px; width: 100%; font-size: 1rem; }
        .btn { padding: 12px 25px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-gold { background: var(--gold); color: var(--dark); }
        .btn-dark { background: var(--dark); color: white; }
        .btn-filter { background: white; border: 1px solid var(--dark); padding: 8px 15px; border-radius: 6px; cursor: pointer; margin-left: 5px; }
        .btn-filter.active { background: var(--dark); color: white; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 15px; border: 1px solid #e2e8f0; text-align: center; }
        th { background: #f1f5f9; }
        
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; }
        .bg-success { background: #dcfce7; color: #166534; }
        .bg-danger { background: #fee2e2; color: #991b1b; }
        
        .hidden { display: none !important; }
        #toast { position: fixed; bottom: 30px; left: 30px; background: var(--dark); color: white; padding: 20px 30px; border-radius: 12px; display: none; z-index: 40000; border-right: 6px solid var(--gold); }
    </style>
</head>
<body>

<div id="loader"><h2>ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©...</h2></div>
<div id="toast"></div>

<div id="auth-screen" style="position:fixed; inset:0; background:var(--dark); display:flex; justify-content:center; align-items:center; z-index:20000;">
    <div style="background:white; padding:40px; border-radius:20px; width:400px; text-align:center; border-top: 5px solid var(--gold);">
        <h2 style="margin-bottom:10px;">Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒÙ„ÙŠØ© Ø§Ù„Ù…ÙˆØ­Ø¯ 2026</h2>
        <p style="color:#64748b;">Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
        <input type="email" id="auth-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
        <input type="password" id="auth-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
        <button class="btn btn-gold" style="width:100%; margin-top:15px;" onclick="handleLogin()">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
    </div>
</div>

<div id="receipt-print">
    <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 15px;">
        <h1>Ø§Ù„ÙƒÙ„ÙŠØ© Ø§Ù„Ù…ÙˆØ­Ø¯Ø© - Ø¥ÙŠØµØ§Ù„ Ù…Ø§Ù„ÙŠ</h1>
    </div>
    <div id="print-content" style="padding: 30px; font-size: 1.2rem;"></div>
</div>

<div class="sidebar hidden" id="sidebar">
    <div class="sidebar-header">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
    <div class="nav-item" onclick="showSec('home')">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
    <div class="nav-item hidden" id="nav-reg" onclick="showSec('registrar')">ğŸ‘¤ Ù…ÙƒØªØ¨ Ø§Ù„Ù…Ø³Ø¬Ù„</div>
    <div class="nav-item hidden" id="nav-fin" onclick="showSec('finance')">ğŸ’° Ù…ÙƒØªØ¨ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</div>
    <div class="nav-item" onclick="openReport()">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
    <div class="nav-item" style="margin-top:auto; color:var(--danger)" onclick="location.reload()">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</div>
</div>

<div class="main-content hidden" id="main-content">
    
    <div id="home" class="section">
        <h1 id="welcome-msg">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….. ğŸ‘‹</h1>
        <p>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ø·Ø§Ù„Ø¨ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª SQL Ø§Ù„Ù…ÙˆØ­Ø¯Ø©:</p>
        <input type="text" id="main-search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ..." onkeyup="renderAll()">
        <table>
            <thead><tr><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
            <tbody id="home-table"></tbody>
        </table>
    </div>

    <div id="registrar" class="section hidden">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1>ğŸ‘¤ Ù…ÙƒØªØ¨ Ø§Ù„Ù…Ø³Ø¬Ù„</h1>
            <button class="btn btn-gold" onclick="toggleBox('add-box')">â• Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</button>
        </div>

        <div id="add-box" class="section hidden" style="background:#f1f5f9;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <input type="text" id="st-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„ÙƒØ§Ù…Ù„">
                <select id="st-dept">
                    <option value="ØªÙ‚Ø§Ù†Ø© Ù†Ø¸Ù… Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª">ØªÙ‚Ø§Ù†Ø© Ù†Ø¸Ù… Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</option>
                    <option value="Ø§Ù„Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©">Ø§Ù„Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</option>
                </select>
                <input type="number" id="st-fee" placeholder="Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„ÙƒÙ„ÙŠØ©">
                <button class="btn btn-dark" onclick="submitToSQL()">Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª</button>
            </div>
        </div>

        <div style="margin:20px 0;">
            <button class="btn-filter active" onclick="setFilter('Ø§Ù„ÙƒÙ„')">Ø§Ù„ÙƒÙ„</button>
            <button class="btn-filter" onclick="setFilter('ØªÙ‚Ø§Ù†Ø© Ù†Ø¸Ù… Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª')">Ù†Ø¸Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</button>
            <button class="btn-filter" onclick="setFilter('Ø§Ù„Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©')">ÙƒÙ‡Ø±Ø¨Ø§Ø¡</button>
        </div>

        <tbody id="reg-table"></tbody>
    </div>

    <div id="finance" class="section hidden">
        <h1>ğŸ’° Ù…ÙƒØªØ¨ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h1>
        <h3>ğŸ”” Ø¯ÙØ¹Ø§Øª ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯</h3>
        <div id="pending-list" style="margin-bottom:30px;"></div>
        <hr>
        <h3>ğŸ“Š Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¤ÙƒØ¯Ø©</h3>
        <table>
            <thead><tr><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</th><th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
            <tbody id="fin-table"></tbody>
        </table>
    </div>
</div>

<script>
    // --- Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ ---
    const CLOUD_URL = "https://script.google.com/macros/s/AKfycbwnSI_EOGSQS2js2nvQ5a_RffqYenWHaHSQRlkHQIUCCwc2vHGI1cshqAkvbEY-8EN-/exec";
    const SUPABASE_URL = "https://xfbhnagbtwaiiitpeula.supabase.co";
    const SUPABASE_KEY = "SUPABASE_KEY=sb_publishable__VhZu3jnCbrBPjJxe2zmEg__rzYOzKS"; // Ø¶Ø¹ Ù…ÙØªØ§Ø­Ùƒ Ø§Ù„ØµØ­ÙŠØ­ Ù‡Ù†Ø§

    let db = [];
    let currentDept = "Ø§Ù„ÙƒÙ„";
    let userRole = "";

    function handleLogin() {
        const email = document.getElementById('auth-email').value;
        const pass = document.getElementById('auth-pass').value;

        if(email === "admin@college.com" && pass === "123456") {
            userRole = "admin";
            document.getElementById('nav-reg').classList.remove('hidden');
            document.getElementById('nav-fin').classList.remove('hidden');
            document.getElementById('welcome-msg').innerText = "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù….. ğŸ›¡ï¸";
        } else if(email === "reg@college.com") {
            userRole = "reg";
            document.getElementById('nav-reg').classList.remove('hidden');
            document.getElementById('welcome-msg').innerText = "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ù…ÙƒØªØ¨ Ø§Ù„Ù…Ø³Ø¬Ù„.. ğŸ‘¤";
        } else if(email === "fin@college.com") {
            userRole = "fin";
            document.getElementById('nav-fin').classList.remove('hidden');
            document.getElementById('welcome-msg').innerText = "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ù…ÙƒØªØ¨ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª.. ğŸ’°";
        } else { return alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø®Ø§Ø·Ø¦Ø©"); }

        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('sidebar').classList.remove('hidden');
        document.getElementById('main-content').classList.remove('hidden');
        refreshData();
    }

    async function refreshData() {
        setLoad(true);
        try {
            const res = await fetch(`${SUPABASE_URL}/rest/v1/students?select=*`, {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
            });
            const data = await res.json();
            db = data.map(s => ({
                id: s.student_id, name: s.full_name, dept: s.department,
                total: s.total_fees, paid: s.paid_fees, status: s.status, confirmed: s.is_confirmed
            }));
            renderAll();
        } catch(e) { showToast("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª SQL", "danger"); }
        setLoad(false);
    }

    function renderAll() {
        const q = document.getElementById('main-search').value.toLowerCase();
        
        // Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        document.getElementById('home-table').innerHTML = db.filter(s => s.name.toLowerCase().includes(q) || s.id.includes(q)).map(s => `
            <tr><td>${s.id}</td><td>${s.name}</td><td>${s.dept}</td>
            <td><span class="status-badge ${s.confirmed?'bg-success':'bg-danger'}">${s.status}</span></td></tr>
        `).join('');

        // Ø§Ù„Ù…Ø³Ø¬Ù„ (Ù…Ø¹ Ø§Ù„ÙÙ„ØªØ±)
        const regData = currentDept === "Ø§Ù„ÙƒÙ„" ? db : db.filter(s => s.dept === currentDept);
        document.getElementById('reg-table').innerHTML = `<table><thead><tr><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody>` + 
        regData.map(s => `<tr><td>${s.id}</td><td>${s.name}</td><td>${s.dept}</td><td>${s.confirmed?'âœ…':'â³'}</td></tr>`).join('') + `</tbody></table>`;

        // Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
        const pending = db.filter(s => !s.confirmed);
        document.getElementById('pending-list').innerHTML = pending.map(s => `
            <div style="background:#fffbeb; padding:15px; border-radius:10px; border:1px solid var(--gold); display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <span>Ø·Ø§Ù„Ø¨: <b>${s.name}</b> | Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${s.total}</span>
                <button class="btn btn-gold" onclick="confirmInSQL('${s.id}', ${s.total})">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… âœ…</button>
            </div>
        `).join('') || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù…Ø¹Ù„Ù‚Ø©";

        document.getElementById('fin-table').innerHTML = db.map(s => `
            <tr><td>${s.id}</td><td>${s.name}</td><td>${s.total}</td><td>${s.paid}</td>
            <td>${s.confirmed? `<button class="btn-dark" onclick="printReceipt('${s.id}')">ğŸ–¨ï¸</button>`:'---'}</td></tr>
        `).join('');
    }

    async function submitToSQL() {
        const name = document.getElementById('st-name').value;
        const dept = document.getElementById('st-dept').value;
        const fee = document.getElementById('st-fee').value;
        const id = (db.length + 2026001).toString();

        if(!name || !fee) return showToast("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "danger");

        setLoad(true);
        await fetch(`${SUPABASE_URL}/rest/v1/students`, {
            method: 'POST',
            headers: { 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json' },
            body: JSON.stringify({ student_id: id, full_name: name, department: dept, total_fees: fee })
        });
        showToast("ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ SQL ÙˆØ¥Ø®Ø·Ø§Ø± Ø§Ù„Ù…Ø­Ø§Ø³Ø¨");
        toggleBox('add-box');
        refreshData();
    }

    async function confirmInSQL(id, amount) {
        setLoad(true);
        await fetch(`${SUPABASE_URL}/rest/v1/students?student_id=eq.${id}`, {
            method: 'PATCH',
            headers: { 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json' },
            body: JSON.stringify({ paid_fees: amount, is_confirmed: true, status: 'Ù…Ø³Ø¬Ù„' })
        });
        showToast("ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­");
        refreshData();
    }

    function setFilter(d) {
        currentDept = d;
        document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        renderAll();
    }

    function printReceipt(id) {
        const s = db.find(x => x.id == id);
        document.getElementById('print-content').innerHTML = `
            <p>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨: <b>${s.name}</b></p>
            <p>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ: <b>${s.id}</b></p>
            <p>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹: <b>${s.paid} Ø¬Ù†ÙŠÙ‡</b></p>
            <p>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p>
        `;
        window.print();
    }

    function showSec(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
    function toggleBox(id) { document.getElementById(id).classList.toggle('hidden'); }
    function setLoad(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; }
    function showToast(m, type="gold") {
        const t = document.getElementById('toast');
        t.innerText = m; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 3000);
    }
    function openReport() {
        if(userRole === "admin") {
            alert("Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù…Ù† SQL...");
            window.print();
        } else { showToast("Ù‡Ø°Ù‡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·", "danger"); }
    }
</script>
</body>
</html>
