<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒÙ„ÙŠØ© Ø§Ù„Ù…ÙˆØ­Ø¯ 2026 | Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© SQL + Sheets</title>
    <style>
        :root { --dark: #0f172a; --gold: #d4af37; --bg: #f8fafc; --success: #10b981; --danger: #e11d48; --white: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: var(--bg); display: flex; min-height: 100vh; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.9); display: none; justify-content: center; align-items: center; z-index: 30000; flex-direction: column; }
        
        /* Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
        #receipt-print { display: none; }
        @media print {
            body * { visibility: hidden; }
            #receipt-print, #receipt-print * { visibility: visible; }
            #receipt-print { display: block; position: absolute; inset: 0; padding: 40px; background: white; border: 2px solid #000; }
        }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        .sidebar { width: 280px; background: var(--dark); color: white; height: 100vh; position: fixed; right: 0; display: flex; flex-direction: column; z-index: 1000; }
        .sidebar-header { padding: 30px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); color: var(--gold); font-size: 1.4rem; font-weight: bold; }
        .nav-item { padding: 18px 25px; cursor: pointer; transition: 0.3s; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .nav-item:hover { background: rgba(255,255,255,0.1); color: var(--gold); padding-right: 35px; }

        /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        .main-content { margin-right: 280px; padding: 40px; width: calc(100% - 280px); transition: 0.3s; }
        .section { background: var(--white); border-radius: 15px; padding: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 30px; border: 1px solid #e2e8f0; }
        
        /* Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± */
        input, select { padding: 12px; margin: 10px 0; border: 1px solid #cbd5e1; border-radius: 8px; width: 100%; box-sizing: border-box; font-size: 1rem; }
        .btn { padding: 12px 25px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-gold { background: var(--gold); color: var(--dark); }
        .btn-dark { background: var(--dark); color: white; }
        
        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 15px; border: 1px solid #e2e8f0; text-align: center; }
        th { background: #f1f5f9; color: var(--dark); }
        
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; }
        .bg-success { background: #dcfce7; color: #166534; }
        .bg-danger { background: #fee2e2; color: #991b1b; }
        
        .hidden { display: none !important; }
        #toast { position: fixed; bottom: 30px; left: 30px; background: var(--dark); color: white; padding: 20px 30px; border-radius: 12px; display: none; z-index: 40000; border-right: 6px solid var(--gold); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }

        .pending-card { background:#fffbeb; padding:20px; border:1px solid var(--gold); border-radius:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; }
    </style>
</head>
<body>

<div id="loader"><h2>ğŸ”„ Ø¬Ø§Ø±ÙŠ Ù…Ø²Ø§Ù…Ù†Ø© SQL Ùˆ Google Sheets...</h2></div>
<div id="toast"></div>

<div id="receipt-print">
    <div style="text-align: center; border-bottom: 3px double #000; padding-bottom: 20px;">
        <h1>Ø§Ù„ÙƒÙ„ÙŠØ© Ø§Ù„Ù…ÙˆØ­Ø¯Ø© - Ø§Ù„Ø³ÙˆØ¯Ø§Ù†</h1>
        <h3>Ø¥ÙŠØµØ§Ù„ Ù…Ø§Ù„ÙŠ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø¹ØªÙ…Ø¯ (SQL Verified)</h3>
    </div>
    <div style="margin-top: 30px; font-size: 1.3rem; line-height: 2;">
        <p>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ: <b id="pr-id"></b></p>
        <p>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨: <b id="pr-name"></b></p>
        <p>Ø§Ù„Ù‚Ø³Ù…: <b id="pr-dept"></b></p>
        <p>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹: <b id="pr-paid"></b> Ø¬Ù†ÙŠÙ‡</p>
        <p>Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„: <b style="color: green;">Ù…Ø¤ÙƒØ¯ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ âœ…</b></p>
    </div>
    <div style="margin-top: 60px; text-align: center;">
        <p>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ ÙˆØ§Ù„Ù…Ø®ØªÙ… Ø§Ù„Ù…Ø§Ù„ÙŠ</p>
    </div>
</div>

<div id="auth-screen" style="position:fixed; inset:0; background:var(--dark); display:flex; justify-content:center; align-items:center; z-index:20000;">
    <div style="background:white; padding:40px; border-radius:20px; width:450px; text-align:center;">
        <h2 style="color:var(--dark);">Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒÙ„ÙŠØ© Ø§Ù„Ù…ÙˆØ­Ø¯ 2026</h2>
        <p>ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
        <input type="email" id="auth-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
        <input type="password" id="auth-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
        <button class="btn btn-gold" style="width:100%; margin-top:10px;" onclick="handleLogin()">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¢Ù…Ù†</button>
    </div>
</div>

<div class="sidebar hidden" id="sidebar">
    <div class="sidebar-header">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… SQL</div>
    <div class="nav-item" onclick="showSec('home')">ğŸ  Ø´Ø§Ø´Ø© Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…</div>
    <div class="nav-item" onclick="showSec('registrar')">ğŸ‘¤ Ù…ÙƒØªØ¨ Ø§Ù„Ù…Ø³Ø¬Ù„</div>
    <div class="nav-item" onclick="showSec('finance')">ğŸ’° Ù…ÙƒØªØ¨ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</div>
    <div class="nav-item" style="margin-top:auto; color:var(--danger)" onclick="location.reload()">ğŸšª Ø®Ø±ÙˆØ¬</div>
</div>

<div class="main-content hidden" id="main-content">
    
    <div id="home" class="section">
        <h1>ğŸ  Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ Ø¹Ù† Ø§Ù„Ø·Ù„Ø§Ø¨</h1>
        <input type="text" id="main-search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… (SQL Fetch)..." onkeyup="renderAll()">
        <table>
            <thead><tr><th>Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
            <tbody id="home-table"></tbody>
        </table>
    </div>

    <div id="registrar" class="section hidden">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1>ğŸ‘¤ Ù…ÙƒØªØ¨ Ø§Ù„Ù…Ø³Ø¬Ù„</h1>
            <button class="btn btn-gold" onclick="toggleBox('add-box')">â• Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</button>
        </div>
        
        <div id="add-box" class="section hidden" style="background:#f1f5f9; border: 2px dashed var(--dark);">
            <h3>ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <input type="text" id="st-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ">
                <select id="st-dept">
                    <option value="ØªÙ‚Ø§Ù†Ø© Ù†Ø¸Ù… Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª">ØªÙ‚Ø§Ù†Ø© Ù†Ø¸Ù… Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</option>
                    <option value="Ø§Ù„Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©">Ø§Ù„Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</option>
                    <option value="Ø§Ù„Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©">Ø§Ù„Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©</option>
                </select>
                <input type="number" id="st-fee" placeholder="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³ÙˆÙ…">
                <button class="btn btn-dark" onclick="submitToSQL()">Ø­ÙØ¸ ÙÙŠ SQL & Sheets</button>
            </div>
        </div>

        <table>
            <thead><tr><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø§Ø¯ÙŠØ©</th></tr></thead>
            <tbody id="reg-table"></tbody>
        </table>
    </div>

    <div id="finance" class="section hidden">
        <h1>ğŸ’° Ù…ÙƒØªØ¨ Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠ</h1>
        <div id="pending-list"></div>
        <hr>
        <h3>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h3>
        <table>
            <thead><tr><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</th><th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
            <tbody id="fin-table"></tbody>
        </table>
    </div>
</div>

<script>
    // --- Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø±Ø¨Ø· (ÙŠØ¬Ø¨ ØªØ¹Ø¨Ø¦ØªÙ‡Ø§) ---
    const CLOUD_URL = "https://script.google.com/macros/s/AKfycbwnSI_EOGSQS2js2nvQ5a_RffqYenWHaHSQRlkHQIUCCwc2vHGI1cshqAkvbEY-8EN-/exec";
    const SUPABASE_URL = "SUPABASE_URL=https://xfbhnagbtwaiiitpeula.supabase.co";
    const SUPABASE_KEY = "SUPABASE_KEY=sb_publishable__VhZu3jnCbrBPjJxe2zmEg__rzYOzKS";

    let db = [];

    // --- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
    function handleLogin() {
        const email = document.getElementById('auth-email').value;
        const pass = document.getElementById('auth-pass').value;
        if(email === "admin@college.com" && pass === "123456") {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('sidebar').classList.remove('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            refreshData();
        } else { showToast("Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©!", "danger"); }
    }

    // --- Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† SQL (Supabase) ---
    async function refreshData() {
        try {
            setLoad(true);
            const res = await fetch(`${SUPABASE_URL}/rest/v1/students?select=*`, {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
            });
            const sqlData = await res.json();
            
            // ØªØ­ÙˆÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª SQL Ù„ØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ù†Ø¸Ø§Ù…
            db = sqlData.map(s => ({
                id: s.student_id,
                name: s.full_name,
                dept: s.department,
                total: s.total_fees,
                paid: s.paid_fees,
                status: s.status,
                confirmed: s.is_confirmed
            }));

            renderAll();
            setLoad(false);
        } catch(e) { 
            showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª SQL", "danger");
            setLoad(false); 
        }
    }

    // --- Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ (SQL + Sheets) ---
    async function submitToSQL() {
        const name = document.getElementById('st-name').value;
        const dept = document.getElementById('st-dept').value;
        const fee = document.getElementById('st-fee').value;
        const id = (db.length + 2026001).toString();

        if(!name || !fee) return showToast("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!", "danger");

        setLoad(true);
        try {
            // 1. Ø§Ù„Ø­ÙØ¸ ÙÙŠ SQL
            await fetch(`${SUPABASE_URL}/rest/v1/students`, {
                method: 'POST',
                headers: { 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    student_id: id,
                    full_name: name,
                    department: dept,
                    total_fees: parseFloat(fee)
                })
            });

            // 2. Ø§Ù„Ø­ÙØ¸ ÙÙŠ Sheets
            await fetch(CLOUD_URL, { 
                method: 'POST', 
                body: JSON.stringify({ action: 'add', row: [id, name, dept, fee] }) 
            });

            showToast("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…ÙŠÙ† âœ…");
            toggleBox('add-box');
            refreshData();
        } catch(e) { showToast("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ", "danger"); }
        setLoad(false);
    }

    // --- ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹ ÙÙŠ SQL ---
    async function confirmPayment(id, amount) {
        setLoad(true);
        try {
            await fetch(`${SUPABASE_URL}/rest/v1/students?student_id=eq.${id}`, {
                method: 'PATCH',
                headers: { 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    paid_fees: parseFloat(amount), 
                    is_confirmed: true,
                    status: 'Ù…Ø³Ø¬Ù„' 
                })
            });
            showToast("ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø¯Ø§Ø¯ ÙÙŠ SQL");
            refreshData();
        } catch(e) { showToast("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); }
        setLoad(false);
    }

    // --- Ø§Ù„Ø¹Ø±Ø¶ ---
    function renderAll() {
        const q = document.getElementById('main-search').value.toLowerCase();
        
        // Ø´Ø§Ø´Ø© Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…
        document.getElementById('home-table').innerHTML = db.filter(s => s.name.toLowerCase().includes(q) || s.id.includes(q)).map(s => `
            <tr><td>${s.id}</td><td>${s.name}</td><td>${s.dept}</td>
            <td><span class="status-badge ${s.status === 'Ù…Ø³Ø¬Ù„'?'bg-success':'bg-danger'}">${s.status}</span></td></tr>
        `).join('');

        // Ù…ÙƒØªØ¨ Ø§Ù„Ù…Ø³Ø¬Ù„
        document.getElementById('reg-table').innerHTML = db.map(s => `
            <tr><td>${s.id}</td><td>${s.name}</td><td>${s.dept}</td>
            <td>${s.confirmed?'âœ…':'â³ Ø§Ù†ØªØ¸Ø§Ø±'}</td></tr>
        `).join('');

        // Ù…ÙƒØªØ¨ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
        const pending = db.filter(s => !s.confirmed);
        document.getElementById('pending-list').innerHTML = pending.map(s => `
            <div class="pending-card">
                <span>Ø§Ù„Ø·Ø§Ù„Ø¨: <b>${s.name}</b> | Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${s.total}</span>
                <button class="btn btn-gold" onclick="confirmPayment('${s.id}', ${s.total})">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</button>
            </div>
        `).join('') || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ù†ØªØ¸Ø§Ø±";

        document.getElementById('fin-table').innerHTML = db.map(s => `
            <tr><td>${s.id}</td><td>${s.name}</td><td>${s.total}</td><td>${s.paid}</td>
            <td>${s.confirmed? `<button onclick="printReceipt('${s.id}')">ğŸ–¨ï¸ Ø¥ÙŠØµØ§Ù„</button>` : '---'}</td></tr>
        `).join('');
    }

    // --- Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ---
    function showSec(id) { document.querySelectorAll('.section').forEach(s => s.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
    function toggleBox(id) { document.getElementById(id).classList.toggle('hidden'); }
    function setLoad(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; }
    function showToast(m, type="gold") {
        const t = document.getElementById('toast');
        t.innerText = m; t.style.display = 'block';
        t.style.borderRightColor = type === "danger" ? "#e11d48" : "#d4af37";
        setTimeout(() => t.style.display = 'none', 3000);
    }
    function printReceipt(id) {
        const s = db.find(x => x.id == id);
        document.getElementById('pr-id').innerText = s.id;
        document.getElementById('pr-name').innerText = s.name;
        document.getElementById('pr-dept').innerText = s.dept;
        document.getElementById('pr-paid').innerText = s.paid;
        window.print();
    }
</script>
</body>
</html>
