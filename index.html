// عنوان السحابة: AKfycbw6ldYrmqMeVaCOFcoO_cPsH93nBpjwemppXcRoe8wzmgMXJS-NwfvsmbfS-SBH6ghJJw
// البريد الإلكتروني للمدير: crazycool0999@gmail.com

function doGet(e) {
  if (e.parameter.format === 'json') {
    const action = e.parameter.action;
    
    switch(action) {
      case 'getDashboard':
        return getDashboardData();
      case 'getStudents':
        return getStudentsData();
      case 'getAllPayments':
        return getAllPayments();
      case 'getAllReceipts':
        return getAllReceipts();
      default:
        return getStudentsData();
    }
  }
  
  if (e.parameter.report === 'true') {
    return generateReport(e);
  }
  
  return HtmlService.createHtmlOutputFromFile('index')
      .setTitle("النظام المتكامل لإدارة الحسابات")
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)
      .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const studentsSheet = ss.getSheetByName("Students") || ss.insertSheet("Students");
    const paymentsSheet = ss.getSheetByName("Payments") || ss.insertSheet("Payments");
    const receiptsSheet = ss.getSheetByName("Receipts") || ss.insertSheet("Receipts");
    const usersSheet = ss.getSheetByName("Users") || ss.insertSheet("Users");
    const resetRequestsSheet = ss.getSheetByName("ResetRequests") || ss.insertSheet("ResetRequests");
    const systemLogsSheet = ss.getSheetByName("SystemLogs") || ss.insertSheet("SystemLogs");
    
    // تسجيل العملية في سجلات النظام
    logSystemAction(systemLogsSheet, data.action, data, e.queryString);
    
    switch(action) {
      case 'login':
        return handleLogin(data, usersSheet);
      case 'requestPasswordReset':
        return handleRequestPasswordReset(data, usersSheet, resetRequestsSheet);
      case 'addStudent':
        return handleAddStudent(data, studentsSheet, paymentsSheet, receiptsSheet);
      case 'getRegistrarStudents':
        return handleGetRegistrarStudents(data, studentsSheet);
      case 'searchStudents':
        return handleSearchStudents(data, studentsSheet);
      case 'getStudentForPayment':
        return handleGetStudentForPayment(data, studentsSheet);
      case 'processPayment':
        return handleProcessPayment(data, studentsSheet, paymentsSheet, receiptsSheet);
      case 'getPendingPayments':
        return handleGetPendingPayments(data, paymentsSheet);
      case 'getConfirmedPayments':
        return handleGetConfirmedPayments(data, paymentsSheet);
      case 'confirmPayment':
        return handleConfirmPayment(data, paymentsSheet, receiptsSheet);
      case 'getReceiptDetails':
        return handleGetReceiptDetails(data, receiptsSheet);
      case 'deleteStudent':
        return handleDeleteStudent(data, studentsSheet);
      case 'getAdminDashboard':
        return handleGetAdminDashboard(data, studentsSheet, paymentsSheet, resetRequestsSheet, usersSheet);
      case 'getUsers':
        return handleGetUsers(data, usersSheet);
      case 'addUser':
        return handleAddUser(data, usersSheet);
      case 'getResetRequests':
        return handleGetResetRequests(data, resetRequestsSheet);
      case 'approveResetRequest':
        return handleApproveResetRequest(data, resetRequestsSheet, usersSheet);
      case 'rejectResetRequest':
        return handleRejectResetRequest(data, resetRequestsSheet);
      case 'getSystemLogs':
        return handleGetSystemLogs(data, systemLogsSheet);
      default:
        return ContentService.createTextOutput(JSON.stringify({
          success: false,
          error: "عملية غير معروفة"
        })).setMimeType(ContentService.MimeType.JSON);
    }
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: error.toString(),
      message: "حدث خطأ في الخادم"
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function initializeSheets() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // إنشاء أوراق العمل إذا لم تكن موجودة
  const sheets = {
    "Students": [
      ["رقم الطالب", "اسم الطالب", "القسم", "السنة", "الفصل", "التخصص",
       "إجمالي الرسوم", "المدفوع", "المتبقي", "الحالة", "رسوم الدراسة",
       "رسوم التسجيل", "رسوم البطاقة", "تاريخ التسجيل", "مسجل بواسطة"]
    ],
    "Payments": [
      ["رقم الإيصال", "رقم الطالب", "اسم الطالب", "القسم", "المبلغ",
       "نوع السداد", "التاريخ", "المستخدم", "الدور", "الحالة", "ملاحظات"]
    ],
    "Receipts": [
      ["رقم الإيصال", "رقم الطالب", "اسم الطالب", "القسم", "السنة", "الفصل",
       "المبلغ", "نوع الإيصال", "التاريخ", "المستخدم", "الحالة", "ملاحظات"]
    ],
    "Users": [
      ["اسم المستخدم", "كلمة المرور", "الاسم الكامل", "البريد الإلكتروني",
       "الدور", "تاريخ التسجيل", "الحالة"]
    ],
    "ResetRequests": [
      ["اسم المستخدم", "البريد الإلكتروني", "تاريخ الطلب", "الحالة", "تمت المعالجة بواسطة"]
    ],
    "SystemLogs": [
      ["التاريخ", "المستخدم", "الإجراء", "التفاصيل", "عنوان IP"]
    ]
  };
  
  for (const [sheetName, headers] of Object.entries(sheets)) {
    let sheet = ss.getSheetByName(sheetName);
    if (!sheet) {
      sheet = ss.insertSheet(sheetName);
      sheet.getRange(1, 1, headers.length, headers[0].length).setValues(headers);
      
      // تنسيق رؤيس الجدول
      const headerRange = sheet.getRange(1, 1, 1, headers[0].length);
      headerRange.setBackground("#2c3e50");
      headerRange.setFontColor("white");
      headerRange.setFontWeight("bold");
    }
  }
  
  // إضافة المستخدمين الأساسيين إذا لم يكونوا موجودين
  const usersSheet = ss.getSheetByName("Users");
  const usersData = usersSheet.getDataRange().getValues();
  let hasAdmin = false;
  let hasRegistrar = false;
  let hasAccounts = false;
  
  for (let i = 1; i < usersData.length; i++) {
    if (usersData[i][0] === "admin") hasAdmin = true;
    if (usersData[i][0] === "registrar") hasRegistrar = true;
    if (usersData[i][0] === "accounts") hasAccounts = true;
  }
  
  const currentDate = new Date().toLocaleString('ar-EG');
  
  if (!hasAdmin) {
    usersSheet.appendRow([
      "admin", "123", "مدير النظام", "crazycool0999@gmail.com",
      "admin", currentDate, "مفعل"
    ]);
  }
  
  if (!hasRegistrar) {
    usersSheet.appendRow([
      "registrar", "2024", "مكتب المسجل", "registrar@college.edu",
      "registrar", currentDate, "مفعل"
    ]);
  }
  
  if (!hasAccounts) {
    usersSheet.appendRow([
      "accounts", "2026", "مكتب الحسابات", "accounts@college.edu",
      "accounts", currentDate, "مفعل"
    ]);
  }
}

function logSystemAction(sheet, action, data, queryString) {
  const date = new Date().toLocaleString('ar-EG');
  const user = data.processedBy || data.addedBy || data.deletedBy || data.requestedBy || data.registeredBy || "غير معروف";
  const ip = queryString ? "من السحابة" : "غير معروف";
  
  sheet.appendRow([date, user, action, JSON.stringify(data), ip]);
}

function handleLogin(data, usersSheet) {
  const users = usersSheet.getDataRange().getValues();
  
  for (let i = 1; i < users.length; i++) {
    if (users[i][0] === data.username && 
        users[i][1] === data.password && 
        users[i][6] === "مفعل") {
      
      return ContentService.createTextOutput(JSON.stringify({
        success: true,
        username: users[i][0],
        fullname: users[i][2],
        role: users[i][4],
        department: users[i][4] === "admin" ? "الإدارة" : 
                   users[i][4] === "registrar" ? "مكتب المسجل" : "مكتب الحسابات"
      })).setMimeType(ContentService.MimeType.JSON);
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify({
    success: false,
    error: "بيانات الدخول غير صحيحة أو الحساب غير مفعل"
  })).setMimeType(ContentService.MimeType.JSON);
}

function handleRequestPasswordReset(data, usersSheet, resetRequestsSheet) {
  const users = usersSheet.getDataRange().getValues();
  let userFound = false;
  
  for (let i = 1; i < users.length; i++) {
    if (users[i][0] === data.username && 
        users[i][3] === data.email && 
        users[i][6] === "مفعل") {
      userFound = true;
      break;
    }
  }
  
  if (!userFound) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: "بيانات المستخدم غير صحيحة أو الحساب غير مفعل"
    })).setMimeType(ContentService.MimeType.JSON);
  }
  
  // التحقق من وجود طلب سابق معلق
  const requests = resetRequestsSheet.getDataRange().getValues();
  for (let i = 1; i < requests.length; i++) {
    if (requests[i][0] === data.username && requests[i][3] === "معلق") {
      return ContentService.createTextOutput(JSON.stringify({
        success: false,
        error: "يوجد طلب معلق سابقاً لهذا المستخدم"
      })).setMimeType(ContentService.MimeType.JSON);
    }
  }
  
  // إضافة طلب جديد
  resetRequestsSheet.appendRow([
    data.username,
    data.email,
    new Date().toLocaleString('ar-EG'),
    "معلق",
    ""
  ]);
  
  return ContentService.createTextOutput(JSON.stringify({
    success: true,
    message: "تم إرسال طلب إعادة التعيين بنجاح"
  })).setMimeType(ContentService.MimeType.JSON);
}

function handleAddStudent(data, studentsSheet, paymentsSheet, receiptsSheet) {
  // توليد رقم طالب جديد
  const students = studentsSheet.getDataRange().getValues();
  let lastId = 1000;
  for (let i = 1; i < students.length; i++) {
    const currentId = parseInt(students[i][0]);
    if (!isNaN(currentId) && currentId > lastId) {
      lastId = currentId;
    }
  }
  const newId = lastId + 1;
  
  // حساب الرسوم
  const studyFees = parseFloat(data.studyFees) || 0;
  const registrationFees = parseFloat(data.registrationFees) || 0;
  const cardFees = parseFloat(data.cardFees) || 0;
  const paidAmount = parseFloat(data.paidAmount) || 0;
  
  const totalFees = studyFees + registrationFees + cardFees;
  const remaining = totalFees - paidAmount;
  const status = remaining <= 0 ? "مسدد" : (paidAmount > 0 ? "قيد السداد" : "غير مسدد");
  
  // إضافة الطالب
  studentsSheet.appendRow([
    newId,
    data.name,
    data.dept,
    data.year,
    data.semester,
    data.major,
    totalFees,
    paidAmount,
    remaining,
    status,
    studyFees,
    registrationFees,
    cardFees,
    new Date().toLocaleString('ar-EG'),
    data.registeredBy
  ]);
  
  let receiptNo = "";
  
  // إذا كان هناك مبلغ مدفوع، تسجيل الدفعة
  if (paidAmount > 0) {
    receiptNo = "REC-" + new Date().getTime() + "-" + newId;
    const paymentType = paidAmount >= totalFees ? "سداد كامل" : "قسط أول";
    
    paymentsSheet.appendRow([
      receiptNo,
      newId,
      data.name,
      data.dept,
      paidAmount,
      paymentType,
      new Date().toLocaleString('ar-EG'),
      data.registeredBy,
      "registrar",
      "معلق",
      "تسجيل طالب جديد"
    ]);
    
    receiptsSheet.appendRow([
      receiptNo,
      newId,
      data.name,
      data.dept,
      data.year,
      data.semester,
      paidAmount,
      "إيصال تسجيل",
      new Date().toLocaleString('ar-EG'),
      data.registeredBy,
      "معلق",
      `تسجيل طالب جديد - ${paymentType}`
    ]);
  }
  
  return ContentService.createTextOutput(JSON.stringify({
    success: true,
    studentId: newId,
    receiptNo: receiptNo,
    total: totalFees,
    remaining: remaining
  })).setMimeType(ContentService.MimeType.JSON);
}

function handleGetRegistrarStudents(data, studentsSheet) {
  const students = studentsSheet.getDataRange().getValues();
  const result = [];
  
  for (let i = 1; i < students.length; i++) {
    if (students[i][14] === data.registrar && students[i][9] !== "محذوف") {
      result.push({
        id: students[i][0],
        name: students[i][1],
        dept: students[i][2],
        year: students[i][3],
        semester: students[i][4],
        major: students[i][5],
        total: parseFloat(students[i][6]) || 0,
        paid: parseFloat(students[i][7]) || 0,
        due: parseFloat(students[i][8]) || 0,
        status: students[i][9]
      });
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify({
    success: true,
    students: result
  })).setMimeType(ContentService.MimeType.JSON);
}

function handleSearchStudents(data, studentsSheet) {
  const students = studentsSheet.getDataRange().getValues();
  const result = [];
  const query = data.query.toLowerCase();
  
  for (let i = 1; i < students.length; i++) {
    if (students[i][9] === "محذوف") continue;
    
    const studentName = students[i][1] || "";
    const studentId = students[i][0]?.toString() || "";
    const studentDept = students[i][2] || "";
    
    if (studentName.toLowerCase().includes(query) || 
        studentId.includes(query) ||
        studentDept.toLowerCase().includes(query)) {
      result.push({
        id: students[i][0],
        name: students[i][1],
        dept: students[i][2],
        year: students[i][3],
        semester: students[i][4],
        total: parseFloat(students[i][6]) || 0,
        paid: parseFloat(students[i][7]) || 0,
        due: parseFloat(students[i][8]) || 0
      });
      
      // الحد الأقصى للنتائج
      if (result.length >= 10) break;
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify({
    success: true,
    students: result
  })).setMimeType(ContentService.MimeType.JSON);
}

function handleGetStudentForPayment(data, studentsSheet) {
  const students = studentsSheet.getDataRange().getValues();
  
  for (let i = 1; i < students.length; i++) {
    if (parseInt(students[i][0]) == parseInt(data.studentId) && students[i][9] !== "محذوف") {
      return ContentService.createTextOutput(JSON.stringify({
        success: true,
        student: {
          id: students[i][0],
          name: students[i][1],
          dept: students[i][2],
          year: students[i][3],
          semester: students[i][4],
          total: parseFloat(students[i][6]) || 0,
          paid: parseFloat(students[i][7]) || 0,
          due: parseFloat(students[i][8]) || 0,
          status: students[i][9]
        }
      })).setMimeType(ContentService.MimeType.JSON);
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify({
    success: false,
    error: "لم يتم العثور على الطالب"
  })).setMimeType(ContentService.MimeType.JSON);
}

function handleProcessPayment(data, studentsSheet, paymentsSheet, receiptsSheet) {
  const students = studentsSheet.getDataRange().getValues();
  let studentRow = -1;
  let studentData = null;
  
  // البحث عن الطالب
  for (let i = 1; i < students.length; i++) {
    if (parseInt(students[i][0]) == parseInt(data.studentId) && students[i][9] !== "محذوف") {
      studentRow = i;
      studentData = students[i];
      break;
    }
  }
  
  if (studentRow === -1) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: "لم يتم العثور على الطالب"
    })).setMimeType(ContentService.MimeType.JSON);
  }
  
  const paymentAmount = parseFloat(data.amount) || 0;
  const currentPaid = parseFloat(studentData[7]) || 0;
  const currentDue = parseFloat(studentData[8]) || 0;
  const totalFees = parseFloat(studentData[6]) || 0;
  
  // تحديث بيانات الطالب
  const newPaid = currentPaid + paymentAmount;
  const newDue = currentDue - paymentAmount;
  const newStatus = newDue <= 0 ? "مسدد" : (newPaid > 0 ? "قيد السداد" : "غير مسدد");
  
  studentsSheet.getRange(studentRow + 1, 8).setValue(newPaid); // المدفوع
  studentsSheet.getRange(studentRow + 1, 9).setValue(newDue); // المتبقي
  studentsSheet.getRange(studentRow + 1, 10).setValue(newStatus); // الحالة
  
  // تسجيل الدفعة
  const receiptNo = "PAY-" + new Date().getTime() + "-" + data.studentId;
  const paymentStatus = data.userRole === "accounts" ? "مؤكد" : "معلق";
  const paymentDate = new Date().toLocaleString('ar-EG');
  
  paymentsSheet.appendRow([
    receiptNo,
    data.studentId,
    studentData[1],
    studentData[2],
    paymentAmount,
    data.paymentType,
    paymentDate,
    data.processedBy,
    data.userRole,
    paymentStatus,
    data.notes || ""
  ]);
  
  receiptsSheet.appendRow([
    receiptNo,
    data.studentId,
    studentData[1],
    studentData[2],
    studentData[3],
    studentData[4],
    paymentAmount,
    "إيصال سداد",
    paymentDate,
    data.processedBy,
    paymentStatus,
    `${data.paymentType} - ${data.notes || ""}`
  ]);
  
  return ContentService.createTextOutput(JSON.stringify({
    success: true,
    receiptNo: receiptNo,
    studentName: studentData[1],
    department: studentData[2],
    year: studentData[3],
    semester: studentData[4],
    amount: paymentAmount,
    total: totalFees,
    remaining: newDue,
    previousPaid: currentPaid,
    paymentType: data.paymentType
  })).setMimeType(ContentService.MimeType.JSON);
}

function handleGetPendingPayments(data, paymentsSheet) {
  const payments = paymentsSheet.getDataRange().getValues();
  const result = [];
  
  for (let i = 1; i < payments.length; i++) {
    if (payments[i][9] === "معلق") {
      result.push({
        receiptNo: payments[i][0],
        studentId: payments[i][1],
        studentName: payments[i][2],
        department: payments[i][3],
        amount: parseFloat(payments[i][4]) || 0,
        type: payments[i][5],
        date: payments[i][6],
        user: payments[i][7],
        role: payments[i][8],
        status: payments[i][9],
        notes: payments[i][10]
      });
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify({
    success: true,
    payments: result
  })).setMimeType(ContentService.MimeType.JSON);
}

function handleGetConfirmedPayments(data, paymentsSheet) {
  const payments = paymentsSheet.getDataRange().getValues();
  const result = [];
  
  for (let i = 1; i < payments.length; i++) {
    if (payments[i][9] === "مؤكد") {
      result.push({
        receiptNo: payments[i][0],
        studentId: payments[i][1],
        studentName: payments[i][2],
        department: payments[i][3],
        amount: parseFloat(payments[i][4]) || 0,
        type: payments[i][5],
        date: payments[i][6],
        user: payments[i][7],
        role: payments[i][8],
        status: payments[i][9],
        notes: payments[i][10]
      });
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify({
    success: true,
    payments: result
  })).setMimeType(ContentService.MimeType.JSON);
}

function handleConfirmPayment(data, paymentsSheet, receiptsSheet) {
  const payments = paymentsSheet.getDataRange().getValues();
  let paymentUpdated = false;
  
  // تحديث حالة الدفعة
  for (let i = 1; i < payments.length; i++) {
    if (payments[i][0] === data.receiptNo && payments[i][9] === "معلق") {
      paymentsSheet.getRange(i + 1, 10).setValue("مؤكد");
      paymentUpdated = true;
      
      // تحديث الإيصال المقابل
      const receipts = receiptsSheet.getDataRange().getValues();
      for (let j = 1; j < receipts.length; j++) {
        if (receipts[j][0] === data.receiptNo) {
          receiptsSheet.getRange(j + 1, 11).setValue("مؤكد");
          break;
        }
      }
      break;
    }
  }
  
  if (paymentUpdated) {
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      message: "تم تأكيد الدفعة بنجاح"
    })).setMimeType(ContentService.MimeType.JSON);
  } else {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: "لم يتم العثور على الدفعة أو تم تأكيدها مسبقاً"
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function handleGetReceiptDetails(data, receiptsSheet) {
  const receipts = receiptsSheet.getDataRange().getValues();
  
  for (let i = 1; i < receipts.length; i++) {
    if (receipts[i][0] === data.receiptNo) {
      return ContentService.createTextOutput(JSON.stringify({
        success: true,
        receipt: {
          receiptNo: receipts[i][0],
          studentId: receipts[i][1],
          studentName: receipts[i][2],
          department: receipts[i][3],
          year: receipts[i][4],
          semester: receipts[i][5],
          amount: parseFloat(receipts[i][6]) || 0,
          type: receipts[i][7],
          date: receipts[i][8],
          user: receipts[i][9],
          status: receipts[i][10],
          notes: receipts[i][11]
        }
      })).setMimeType(ContentService.MimeType.JSON);
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify({
    success: false,
    error: "لم يتم العثور على الإيصال"
  })).setMimeType(ContentService.MimeType.JSON);
}

function handleDeleteStudent(data, studentsSheet) {
  const students = studentsSheet.getDataRange().getValues();
  
  for (let i = 1; i < students.length; i++) {
    if (parseInt(students[i][0]) == parseInt(data.studentId) && students[i][9] !== "محذوف") {
      studentsSheet.getRange(i + 1, 10).setValue("محذوف");
      return ContentService.createTextOutput(JSON.stringify({
        success: true,
        message: "تم حذف الطالب بنجاح"
      })).setMimeType(ContentService.MimeType.JSON);
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify({
    success: false,
    error: "لم يتم العثور على الطالب"
  })).setMimeType(ContentService.MimeType.JSON);
}

function getDashboardData() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const studentsSheet = ss.getSheetByName("Students");
  const paymentsSheet = ss.getSheetByName("Payments");
  
  const students = studentsSheet.getDataRange().getValues();
  const payments = paymentsSheet.getDataRange().getValues();
  
  let totalStudents = 0;
  let paidStudents = 0;
  let unpaidStudents = 0;
  let pendingStudents = 0;
  let pendingPayments = 0;
  
  // حساب إحصاءات الطلاب
  for (let i = 1; i < students.length; i++) {
    if (students[i][9] === "محذوف") continue;
    
    totalStudents++;
    const status = students[i][9];
    const due = parseFloat(students[i][8]) || 0;
    
    if (due <= 0) {
      paidStudents++;
    } else if (status === "غير مسدد") {
      unpaidStudents++;
    } else if (status === "قيد السداد") {
      pendingStudents++;
    }
  }
  
  // حساب المدفوعات المعلقة
  for (let i = 1; i < payments.length; i++) {
    if (payments[i][9] === "معلق") {
      pendingPayments++;
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify({
    success: true,
    totalStudents: totalStudents,
    paidStudents: paidStudents,
    unpaidStudents: unpaidStudents,
    pendingStudents: pendingStudents,
    pendingPayments: pendingPayments
  })).setMimeType(ContentService.MimeType.JSON);
}

function getStudentsData() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const studentsSheet = ss.getSheetByName("Students");
  const students = studentsSheet.getDataRange().getValues();
  const result = [];
  
  for (let i = 1; i < students.length; i++) {
    if (students[i][9] !== "محذوف") {
      result.push({
        id: students[i][0],
        name: students[i][1],
        dept: students[i][2],
        year: students[i][3],
        semester: students[i][4],
        major: students[i][5],
        total: parseFloat(students[i][6]) || 0,
        paid: parseFloat(students[i][7]) || 0,
        due: parseFloat(students[i][8]) || 0,
        status: students[i][9]
      });
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify({
    success: true,
    students: result
  })).setMimeType(ContentService.MimeType.JSON);
}

function getAllPayments() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const paymentsSheet = ss.getSheetByName("Payments");
  const payments = paymentsSheet.getDataRange().getValues();
  const result = [];
  
  for (let i = 1; i < payments.length; i++) {
    result.push({
      receiptNo: payments[i][0],
      studentId: payments[i][1],
      studentName: payments[i][2],
      department: payments[i][3],
      amount: parseFloat(payments[i][4]) || 0,
      type: payments[i][5],
      date: payments[i][6],
      user: payments[i][7],
      role: payments[i][8],
      status: payments[i][9],
      notes: payments[i][10]
    });
  }
  
  return ContentService.createTextOutput(JSON.stringify({
    success: true,
    payments: result
  })).setMimeType(ContentService.MimeType.JSON);
}

function getAllReceipts() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const receiptsSheet = ss.getSheetByName("Receipts");
  const receipts = receiptsSheet.getDataRange().getValues();
  const result = [];
  
  for (let i = 1; i < receipts.length; i++) {
    result.push({
      receiptNo: receipts[i][0],
      studentId: receipts[i][1],
      studentName: receipts[i][2],
      department: receipts[i][3],
      year: receipts[i][4],
      semester: receipts[i][5],
      amount: parseFloat(receipts[i][6]) || 0,
      type: receipts[i][7],
      date: receipts[i][8],
      user: receipts[i][9],
      status: receipts[i][10],
      notes: receipts[i][11]
    });
  }
  
  return ContentService.createTextOutput(JSON.stringify({
    success: true,
    receipts: result
  })).setMimeType(ContentService.MimeType.JSON);
}

function handleGetAdminDashboard(data, studentsSheet, paymentsSheet, resetRequestsSheet, usersSheet) {
  const students = studentsSheet.getDataRange().getValues();
  const payments = paymentsSheet.getDataRange().getValues();
  const resetRequests = resetRequestsSheet.getDataRange().getValues();
  const users = usersSheet.getDataRange().getValues();
  
  let totalStudents = 0;
  let paidStudents = 0;
  let unpaidStudents = 0;
  let pendingStudents = 0;
  let pendingPayments = 0;
  let pendingResetRequests = 0;
  
  // حساب إحصاءات الطلاب
  for (let i = 1; i < students.length; i++) {
    if (students[i][9] === "محذوف") continue;
    
    totalStudents++;
    const status = students[i][9];
    const due = parseFloat(students[i][8]) || 0;
    
    if (due <= 0) {
      paidStudents++;
    } else if (status === "غير مسدد") {
      unpaidStudents++;
    } else if (status === "قيد السداد") {
      pendingStudents++;
    }
  }
  
  // حساب المدفوعات المعلقة
  for (let i = 1; i < payments.length; i++) {
    if (payments[i][9] === "معلق") {
      pendingPayments++;
    }
  }
  
  // حساب طلبات إعادة التعيين المعلقة
  for (let i = 1; i < resetRequests.length; i++) {
    if (resetRequests[i][3] === "معلق") {
      pendingResetRequests++;
    }
  }
  
  // تحضير قائمة المستخدمين
  const usersList = [];
  for (let i = 1; i < users.length; i++) {
    usersList.push({
      username: users[i][0],
      fullname: users[i][2],
      email: users[i][3],
      role: users[i][4],
      registrationDate: users[i][5],
      status: users[i][6]
    });
  }
  
  // تحضير قائمة طلبات إعادة التعيين
  const resetRequestsList = [];
  for (let i = 1; i < resetRequests.length; i++) {
    if (resetRequests[i][3] === "معلق") {
      resetRequestsList.push({
        username: resetRequests[i][0],
        email: resetRequests[i][1],
        requestDate: resetRequests[i][2],
        status: resetRequests[i][3]
      });
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify({
    success: true,
    totalStudents: totalStudents,
    paidStudents: paidStudents,
    unpaidStudents: unpaidStudents,
    pendingStudents: pendingStudents,
    pendingPayments: pendingPayments,
    resetRequests: pendingResetRequests,
    users: usersList,
    resetRequestsList: resetRequestsList
  })).setMimeType(ContentService.MimeType.JSON);
}

function handleGetUsers(data, usersSheet) {
  const users = usersSheet.getDataRange().getValues();
  const result = [];
  
  for (let i = 1; i < users.length; i++) {
    result.push({
      username: users[i][0],
      fullname: users[i][2],
      email: users[i][3],
      role: users[i][4],
      registrationDate: users[i][5],
      status: users[i][6]
    });
  }
  
  return ContentService.createTextOutput(JSON.stringify({
    success: true,
    users: result
  })).setMimeType(ContentService.MimeType.JSON);
}

function handleAddUser(data, usersSheet) {
  const users = usersSheet.getDataRange().getValues();
  
  // التحقق من عدم وجود اسم مستخدم مكرر
  for (let i = 1; i < users.length; i++) {
    if (users[i][0] === data.username) {
      return ContentService.createTextOutput(JSON.stringify({
        success: false,
        error: "اسم المستخدم موجود بالفعل"
      })).setMimeType(ContentService.MimeType.JSON);
    }
  }
  
  // إضافة المستخدم الجديد
  usersSheet.appendRow([
    data.username,
    data.password,
    data.fullname,
    data.email,
    data.role,
    new Date().toLocaleString('ar-EG'),
    "مفعل"
  ]);
  
  return ContentService.createTextOutput(JSON.stringify({
    success: true,
    message: "تم إضافة المستخدم بنجاح"
  })).setMimeType(ContentService.MimeType.JSON);
}

function handleGetResetRequests(data, resetRequestsSheet) {
  const requests = resetRequestsSheet.getDataRange().getValues();
  const result = [];
  
  for (let i = 1; i < requests.length; i++) {
    if (requests[i][3] === "معلق") {
      result.push({
        username: requests[i][0],
        email: requests[i][1],
        requestDate: requests[i][2],
        status: requests[i][3]
      });
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify({
    success: true,
    requests: result
  })).setMimeType(ContentService.MimeType.JSON);
}

function handleApproveResetRequest(data, resetRequestsSheet, usersSheet) {
  const requests = resetRequestsSheet.getDataRange().getValues();
  const users = usersSheet.getDataRange().getValues();
  
  let requestRow = -1;
  let userRow = -1;
  let userEmail = "";
  
  // البحث عن الطلب والمستخدم
  for (let i = 1; i < requests.length; i++) {
    if (requests[i][0] === data.username && requests[i][3] === "معلق") {
      requestRow = i;
      userEmail = requests[i][1];
      break;
    }
  }
  
  for (let i = 1; i < users.length; i++) {
    if (users[i][0] === data.username) {
      userRow = i;
      break;
    }
  }
  
  if (requestRow === -1 || userRow === -1) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: "لم يتم العثور على الطلب أو المستخدم"
    })).setMimeType(ContentService.MimeType.JSON);
  }
  
  // إنشاء كلمة مرور جديدة
  const newPassword = Math.random().toString(36).slice(-8);
  
  // تحديث كلمة المرور في قاعدة البيانات
  usersSheet.getRange(userRow + 1, 2).setValue(newPassword);
  
  // تحديث حالة الطلب
  resetRequestsSheet.getRange(requestRow + 1, 4).setValue("تمت الموافقة");
  resetRequestsSheet.getRange(requestRow + 1, 5).setValue(data.approvedBy);
  
  // إرسال البريد الإلكتروني بكلمة المرور الجديدة
  try {
    const subject = "إعادة تعيين كلمة المرور - النظام المتكامل لإدارة الحسابات";
    const body = `
عزيزي المستخدم،

تمت الموافقة على طلب إعادة تعيين كلمة المرور لحسابك في النظام المتكامل لإدارة الحسابات.

تفاصيل الحساب:
اسم المستخدم: ${data.username}
كلمة المرور الجديدة: ${newPassword}

يرجى تسجيل الدخول باستخدام كلمة المرور الجديدة وتغييرها فوراً لأسباب أمنية.

مع تحيات،
إدارة النظام
كلية الدمازين التقنية
    `;
    
    MailApp.sendEmail({
      to: userEmail,
      subject: subject,
      body: body
    });
    
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      message: "تمت الموافقة على الطلب وإرسال كلمة المرور الجديدة"
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: "تم تحديث كلمة المرور ولكن حدث خطأ في إرسال البريد الإلكتروني: " + error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function handleRejectResetRequest(data, resetRequestsSheet) {
  const requests = resetRequestsSheet.getDataRange().getValues();
  let requestRow = -1;
  
  for (let i = 1; i < requests.length; i++) {
    if (requests[i][0] === data.username && requests[i][3] === "معلق") {
      requestRow = i;
      break;
    }
  }
  
  if (requestRow === -1) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: "لم يتم العثور على الطلب"
    })).setMimeType(ContentService.MimeType.JSON);
  }
  
  // تحديث حالة الطلب
  resetRequestsSheet.getRange(requestRow + 1, 4).setValue("مرفوض");
  resetRequestsSheet.getRange(requestRow + 1, 5).setValue(data.rejectedBy);
  
  return ContentService.createTextOutput(JSON.stringify({
    success: true,
    message: "تم رفض الطلب بنجاح"
  })).setMimeType(ContentService.MimeType.JSON);
}

function handleGetSystemLogs(data, systemLogsSheet) {
  const logs = systemLogsSheet.getDataRange().getValues();
  const result = [];
  
  // إرجاع آخر 100 سجل
  const startRow = Math.max(1, logs.length - 100);
  for (let i = startRow; i < logs.length; i++) {
    result.push({
      date: logs[i][0],
      user: logs[i][1],
      action: logs[i][2],
      details: logs[i][3],
      ip: logs[i][4]
    });
  }
  
  // عكس الترتيب للحصول على أحدث السجلات أولاً
  result.reverse();
  
  return ContentService.createTextOutput(JSON.stringify({
    success: true,
    logs: result
  })).setMimeType(ContentService.MimeType.JSON);
}

function generateReport(e) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("Students");
  const data = sheet.getDataRange().getValues();
  
  const reportType = e.parameter.type || 'all';
  const department = e.parameter.dept || '';
  
  const filteredData = [];
  
  for (let i = 1; i < data.length; i++) {
    let include = true;
    
    if (data[i][9] === "محذوف") continue;
    
    if (department && data[i][2] !== department) include = false;
    
    if (include) {
      const total = parseFloat(data[i][6]) || 0;
      const paid = parseFloat(data[i][7]) || 0;
      const due = parseFloat(data[i][8]) || 0;
      const status = data[i][9];
      
      // فلترة حسب نوع التقرير
      if (reportType === 'paid' && due > 0) continue;
      if (reportType === 'unpaid' && due <= 0) continue;
      
      filteredData.push({
        id: data[i][0],
        name: data[i][1],
        dept: data[i][2],
        year: data[i][3],
        semester: data[i][4],
        major: data[i][5],
        total: total,
        paid: paid,
        due: due,
        studyFees: data[i][10] || 0,
        registrationFees: data[i][11] || 0,
        cardFees: data[i][12] || 0
      });
    }
  }
  
  return createReportHTML(filteredData, reportType, department);
}

function createReportHTML(data, reportType, department) {
  const reportTypeName = getReportTypeName(reportType);
  const deptName = department || "جميع الأقسام";
  
  let html = `
    <!DOCTYPE html>
    <html lang="ar" dir="rtl">
    <head>
        <meta charset="UTF-8">
        <title>تقرير النظام المتكامل</title>
        <style>
            body {
                font-family: 'Cairo', sans-serif;
                margin: 0;
                padding: 20px;
                background: white;
            }
            .header {
                text-align: center;
                border-bottom: 3px solid #3498db;
                padding-bottom: 20px;
                margin-bottom: 30px;
            }
            .header h1 {
                color: #2c3e50;
                margin: 0;
            }
            .info {
                background: #f8f9fa;
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 20px;
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 10px;
            }
            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
            }
            th {
                background: #2c3e50;
                color: white;
                padding: 12px;
                text-align: right;
            }
            td {
                padding: 10px;
                border-bottom: 1px solid #ddd;
                text-align: right;
            }
            tr:nth-child(even) {
                background: #f8f9fa;
            }
            .summary {
                background: #e8f4fd;
                padding: 20px;
                border-radius: 10px;
                margin: 20px 0;
            }
            @media print {
                .no-print { display: none; }
            }
        </style>
    </head>
    <body>
        <div class="header">
            <h1>كلية الدمازين التقنية</h1>
            <h2>جامعة السودان التقنية</h2>
            <h3>تقرير النظام المتكامل لإدارة الحسابات</h3>
            <h4>${reportTypeName}</h4>
        </div>
        
        <div class="info">
            <div><strong>القسم:</strong> ${deptName}</div>
            <div><strong>عدد السجلات:</strong> ${data.length}</div>
            <div><strong>تاريخ التقرير:</strong> ${new Date().toLocaleDateString('ar-EG')}</div>
        </div>
        
        <div class="summary">
            <h4>ملخص التقرير:</h4>
            <p><strong>إجمالي الرسوم:</strong> ${data.reduce((sum, item) => sum + item.total, 0).toFixed(2)} جنيه</p>
            <p><strong>إجمالي المدفوع:</strong> ${data.reduce((sum, item) => sum + item.paid, 0).toFixed(2)} جنيه</p>
            <p><strong>إجمالي المتبقي:</strong> ${data.reduce((sum, item) => sum + item.due, 0).toFixed(2)} جنيه</p>
        </div>
        
        <table>
            <thead>
                <tr>
                    <th>الرقم</th>
                    <th>اسم الطالب</th>
                    <th>القسم</th>
                    <th>السنة</th>
                    <th>الفصل</th>
                    <th>التخصص</th>
                    <th>رسوم الدراسة</th>
                    <th>رسوم التسجيل</th>
                    <th>رسوم البطاقة</th>
                    <th>إجمالي الرسوم</th>
                    <th>المدفوع</th>
                    <th>المتبقي</th>
                    <th>الحالة</th>
                </tr>
            </thead>
            <tbody>`;
  
  data.forEach(item => {
    const status = item.due <= 0 ? "مسدد" : item.due === item.total ? "غير مسدد" : "قيد السداد";
    const statusColor = item.due <= 0 ? "#27ae60" : item.due === item.total ? "#e74c3c" : "#f39c12";
    
    html += `
                <tr>
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td>${item.dept}</td>
                    <td>${item.year}</td>
                    <td>${item.semester}</td>
                    <td>${item.major}</td>
                    <td>${(item.studyFees || 0).toFixed(2)}</td>
                    <td>${(item.registrationFees || 0).toFixed(2)}</td>
                    <td>${(item.cardFees || 0).toFixed(2)}</td>
                    <td>${item.total.toFixed(2)}</td>
                    <td>${item.paid.toFixed(2)}</td>
                    <td>${item.due.toFixed(2)}</td>
                    <td style="color: ${statusColor}; font-weight: bold;">${status}</td>
                </tr>`;
  });
  
  html += `
            </tbody>
        </table>
        
        <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd;">
            <p>تم إنشاء هذا التقرير بواسطة النظام المتكامل لإدارة الحسابات</p>
            <p>${new Date().toLocaleString('ar-EG')}</p>
        </div>
        
        <div class="no-print" style="text-align: center; margin-top: 20px;">
            <button onclick="window.print()" style="background: #3498db; color: white; border: none; 
                    padding: 10px 30px; border-radius: 5px; cursor: pointer;">
                طباعة التقرير
            </button>
            <button onclick="window.close()" style="background: #95a5a6; color: white; border: none; 
                    padding: 10px 30px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                إغلاق
            </button>
        </div>
        
        <script>
            window.onload = function() {
                window.print();
            };
        </script>
    </body>
    </html>`;
 
